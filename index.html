<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Парсер корзины Lego из файла</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .input-area label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .input-area input[type="file"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
        }
        input[type="file"]::file-selector-button {
            margin-right: 15px;
            border: none;
            background: #007bff;
            padding: 8px 12px;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            transition: background-color .2s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover {
            background: #0056b3;
        }
        .input-area button {
            padding: 12px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1em;
            width: 100%;
            max-width: 300px;
        }
        .input-area button:hover {
            background-color: #218838;
        }
        .parts-list {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .part-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .part-item img {
            max-width: 60px;
            max-height: 60px;
            border: 1px solid #ddd;
            object-fit: contain;
        }
        .part-info {
            flex-grow: 1;
        }
        .part-name {
            font-weight: bold;
            color: #444;
            font-size: 0.95em;
        }
        .part-quantity {
            color: #666;
            font-size: 0.9em;
        }
        .loading-message, .error-message, .info-message, .warning-message {
            text-align: center;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
        .loading-message {
            background-color: #e0e0e0;
            color: #555;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Парсер корзины Lego из файла</h1>
        <div class="input-area">
            <label for="htmlFileInput">Выберите сохраненный HTML файл корзины:</label>
            <input type="file" id="htmlFileInput" accept=".html, .htm">
            <button id="processFileButton">Обработать файл</button>
        </div>
        <div id="messageArea">
            <div class="info-message">
                <strong>Как использовать:</strong>
                <ol style="text-align: left; margin-top: 10px;">
                    <li>Откройте страницу с общей корзиной в браузере (например, <code style="background: #eee; padding: 2px 4px; border-radius: 3px;">https://shop-device.ru/sharebasket/...</code>).</li>
                    <li>Сохраните эту страницу на ваш компьютер (Ctrl+S или Файл → Сохранить как...). Выберите тип "HTML Only".</li>
                    <li>Нажмите "Выберите файл" и загрузите сохраненный HTML-файл.</li>
                    <li>Нажмите "Обработать файл".</li>
                </ol>
            </div>
        </div>
        <div id="partsList" class="parts-list"></div>
    </div>

    <script>
        const fileInput = document.getElementById('htmlFileInput');
        const processButton = document.getElementById('processFileButton');
        const partsListDiv = document.getElementById('partsList');
        const messageArea = document.getElementById('messageArea');

        processButton.addEventListener('click', () => {
            partsListDiv.innerHTML = ''; // Очищаем предыдущий список
            clearMessages(); // Очищаем сообщения

            const file = fileInput.files[0];
            if (!file) {
                displayMessage("Пожалуйста, выберите HTML файл для обработки.", "warning");
                return;
            }

            displayMessage("Чтение файла...", "loading");

            const reader = new FileReader();
            reader.onload = (event) => {
                const htmlContent = event.target.result;
                clearLoadingMessage();

                if (!htmlContent) {
                    displayMessage("Не удалось прочитать содержимое файла.", "error");
                    return;
                }

                displayMessage("Анализ HTML...", "loading", true);

                try {
                    const parsedData = parseBasketHtml(htmlContent);
                    clearLoadingMessage();
                    displayParts(parsedData);
                    if (parsedData.length === 0) {
                        displayMessage("Детали в файле не найдены или структура HTML не соответствует ожидаемой.", "warning", true);
                    } else {
                        displayMessage(`Найдено и отображено деталей: ${parsedData.length}`, "info", true);
                    }
                } catch (error) {
                    console.error("Ошибка парсинга HTML:", error);
                    clearLoadingMessage();
                    displayMessage(`Ошибка при анализе HTML: ${error.message}. Проверьте файл и попробуйте снова.`, "error");
                }
            };

            reader.onerror = (event) => {
                console.error("Ошибка чтения файла:", event.target.error);
                clearMessages();
                displayMessage(`Ошибка при чтении файла: ${event.target.error.name}`, "error");
            };

            reader.readAsText(file); // Читаем файл как текст
        });

        /**
         * Парсит HTML-код корзины и извлекает данные о товарах.
         * @param {string} htmlString - HTML-код страницы.
         * @returns {Array<object>} Массив объектов { name, quantity, imageUrl }.
         */
        function parseBasketHtml(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const itemsContainer = doc.querySelector('.basket-share-detail__items');

            if (!itemsContainer) {
                console.warn("Контейнер '.basket-share-detail__items' не найден.");
                return [];
            }

            const items = itemsContainer.querySelectorAll('.basket-share-detail__item');
            const partsData = [];
            // Определяем базовый URL. Сначала ищем тег <base>, если нет, используем shop-device.ru
            let baseUrl = 'https://shop-device.ru';
            const baseTag = doc.querySelector('base[href]');
            if (baseTag && baseTag.href && baseTag.href.startsWith('http')) {
                baseUrl = baseTag.href.replace(/\/$/, ''); // Убираем слэш в конце, если есть
                 console.log(`Using base URL from <base> tag: ${baseUrl}`);
            } else {
                 console.log(`Using default base URL: ${baseUrl}`);
            }


            items.forEach((item) => {
                const nameElement = item.querySelector('.basket-share-detail__item__name a.dark_link');
                const quantityElement = item.querySelector('.basket-share-detail__item__quantity');
                // Ищем изображение внутри ссылки, которая может быть родителем img
                const imageLink = item.querySelector('.basket-share-detail__item__image a.thumb');
                const imageElement = imageLink ? imageLink.querySelector('img') : item.querySelector('.basket-share-detail__item__image img'); // Запасной вариант

                let name = nameElement ? nameElement.textContent.trim() : 'Название не найдено';
                let quantity = 0;
                if (quantityElement) {
                    const quantityText = quantityElement.textContent.trim();
                    const match = quantityText.match(/(\d+)/);
                    if (match) quantity = parseInt(match[1], 10);
                }

                // --- ИЗМЕНЕННЫЙ БЛОК ДЛЯ URL ИЗОБРАЖЕНИЯ ---
                let imageUrl = 'placeholder.png'; // Заглушка по умолчанию
                if (imageElement) {
                    // Приоритет отдаем data-src, если он есть, иначе берем src
                    let potentialSrc = imageElement.getAttribute('data-src') || imageElement.getAttribute('src');

                    if (potentialSrc) { // Если нашли какой-либо источник (data-src или src)
                        if (potentialSrc.startsWith('/')) {
                            // Если это корневой относительный путь (как в data-src), добавляем базу
                            imageUrl = baseUrl + potentialSrc;
                        } else if (potentialSrc.startsWith('http')) {
                            // Если это уже абсолютный URL
                            imageUrl = potentialSrc;
                        }
                        // Игнорируем локальные пути сохранения (начинающиеся с точки или без слеша/http)
                        // console.log(`Resolved image URL: ${imageUrl}`); // Для отладки
                    }
                }
                // --- КОНЕЦ ИЗМЕНЕННОГО БЛОКА ---

                if (name !== 'Название не найдено' && quantity > 0) {
                    partsData.push({ name, quantity, imageUrl });
                } else {
                    console.warn("Skipping item due to missing name or quantity:", item);
                }
            });

            return partsData;
        }

        /**
         * Отображает список деталей на странице.
         * @param {Array<object>} parts - Массив деталей.
         */
        function displayParts(parts) {
            partsListDiv.innerHTML = '<h2>Содержимое корзины из файла</h2>';
            if (!parts || parts.length === 0) {
                // Не добавляем сообщение здесь, оно будет добавлено из вызывающей функции
                return;
            }

            parts.forEach(part => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('part-item');

                const img = document.createElement('img');
                img.src = part.imageUrl;
                img.alt = part.name.substring(0, 50);
                img.onerror = () => { // Обработчик ошибок загрузки изображения
                    img.alt = 'Изображение недоступно';
                    img.style.border = '1px solid red';
                    // Устанавливаем прозрачный пиксель или другую заглушку
                    img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    console.warn(`Failed to load image: ${part.imageUrl}`);
                };

                const infoDiv = document.createElement('div');
                infoDiv.classList.add('part-info');

                const nameP = document.createElement('p');
                nameP.classList.add('part-name');
                nameP.textContent = part.name;

                const quantityP = document.createElement('p');
                quantityP.classList.add('part-quantity');
                quantityP.textContent = `Количество: ${part.quantity}`;

                infoDiv.appendChild(nameP);
                infoDiv.appendChild(quantityP);
                itemDiv.appendChild(img);
                itemDiv.appendChild(infoDiv);
                partsListDiv.appendChild(itemDiv);
            });
        }

        /**
         * Отображает сообщение для пользователя.
         * @param {string} text - Текст сообщения.
         * @param {string} type - Тип сообщения (info, error, warning, loading).
         * @param {boolean} append - Добавлять сообщение или заменять существующие.
         */
        function displayMessage(text, type = "info", append = false) {
            if (!append && type !== 'loading') {
                clearMessages(false); // Очищаем все, кроме info и loading
            } else if (!append) {
                 // Если не добавляем и это loading, очищаем все (включая info)
                 clearMessages(true);
            }


            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = text; // Используем innerHTML для поддержки тегов в сообщениях (например, <strong>)
            messageDiv.classList.add(`${type}-message`);
            messageArea.appendChild(messageDiv);
        }

        /**
         * Удаляет сообщения.
         * @param {boolean} all - Удалить все сообщения или только не-info и не-loading.
         */
        function clearMessages(all = true) {
            const types = all
                ? ['.info-message', '.error-message', '.warning-message', '.loading-message']
                : ['.error-message', '.warning-message', '.loading-message']; // По умолчанию не трогаем info
            types.forEach(selector => {
                messageArea.querySelectorAll(selector).forEach(msg => {
                    // Не удаляем изначальное info сообщение с инструкцией
                    if (!msg.querySelector('strong') || msg.querySelector('strong').textContent !== 'Как использовать:') {
                         msg.remove();
                    } else if (all) {
                        // Если нужно удалить все, включая инструкцию (например, при новой загрузке)
                        // Но пока оставим инструкцию всегда видимой
                        // msg.remove();
                    }
                });
            });
        }


        /** Удаляет сообщения о загрузке */
        function clearLoadingMessage() {
            messageArea.querySelectorAll('.loading-message').forEach(msg => msg.remove());
        }
    </script>
</body>
</html>
