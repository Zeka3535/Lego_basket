<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог LEGO деталей (из корзины)</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --danger-color: #dc3545;
            --text-color: #333;
            --background-color: #f4f4f4;
            --lego-red: #d81e2b;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            color: var(--text-color);
            line-height: 1.6;
            background-color: var(--background-color);
        }
        .container {
            width: 85%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .logo-and-input {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            gap: 20px;
        }
        h1 {
            text-align: left;
            margin: 0;
            flex-shrink: 0;
        }
        h1 img {
            width: 100px;
            height: auto;
            transition: transform 0.3s ease;
            vertical-align: middle;
        }
        h1:hover img {
            transform: scale(1.1);
        }
        .file-input-area {
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 15px;
            flex-grow: 1;
            background-color: #f9f9f9;
        }
        .file-input-area:hover {
            cursor: pointer;
            background-color: #f0f0f0;
        }
        #file-info {
            font-style: italic;
            color: #555;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-grow: 1;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #button-container {
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .button {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            background-color: var(--primary-color);
            color: #fff;
            transition: background-color 0.2s ease, transform 0.2s ease;
            flex-shrink: 0;
        }
        .button:hover {
            transform: scale(1.03);
        }
        .button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        #load-file-button { background-color: var(--primary-color); }
        #load-file-button:hover { background-color: #0056b3; }
        #clear-button { background-color: var(--danger-color); }
        #clear-button:hover { background-color: #c82333; }
        #export-button { background-color: var(--secondary-color); }
        #export-button:hover { background-color: #218838; }
        #theme-toggle { background-color: #6c757d; }
        #theme-toggle:hover { background-color: #5a6268; }
        .instructions {
            background-color: #eef;
            border: 1px solid #ccd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .instructions summary {
            font-weight: bold;
            cursor: pointer;
        }
        .instructions ol {
            margin-top: 10px;
            padding-left: 20px;
        }
        .instructions code {
            background: #ddd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        #error-message, #info-message {
            text-align: center;
            display: none;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid;
        }
        #error-message {
            color: var(--danger-color);
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        #info-message {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        #total-parts-container {
            text-align: right;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            color: #555;
        }
        #total-parts-container img {
            width: 20px;
            height: auto;
            vertical-align: middle;
            margin-right: 5px;
            opacity: 0.8;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
            font-size: 0.95rem;
            vertical-align: middle;
        }
        td:nth-child(1), th:nth-child(1) { text-align: center; width: 5%; }
        td:nth-child(2) { word-break: break-word; width: 37%; }
        td:nth-child(3), th:nth-child(3) { text-align: center; width: 10%; }
        td:nth-child(4), th:nth-child(4) { text-align: center; width: 8%; }
        td:nth-child(5), th:nth-child(5) { width: 15%; }
        td:nth-child(6), th:nth-child(6) { width: 10%; }
        td:nth-child(7), th:nth-child(7) { width: 15%; }
        th {
            background-color: #f7f7f7;
            font-weight: 600;
            color: #555;
            cursor: default;
            transition: background-color 0.2s ease;
            position: relative;
        }
        th[data-sortable="true"] { cursor: pointer; }
        th[data-sortable="true"]:hover { background-color: #eee; }
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        th.sort-asc::after {
            border-bottom: 5px solid #555;
            opacity: 1;
        }
        th.sort-desc::after {
            border-top: 5px solid #555;
            opacity: 1;
        }
        tbody tr:nth-child(even) { background-color: #fcfcfc; }
        tbody tr:hover { background-color: #f0f8ff; }
        .filter-column {
            display: block;
            width: 95%;
            margin-top: 5px;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #fff;
            color: var(--text-color);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 6 5-6H1z' fill='%23555'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 25px;
        }
        .filter-column:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 1px;
        }
        .part-image {
            max-width: 50px;
            max-height: 50px;
            vertical-align: middle;
            border-radius: 4px;
            background-color: #f0f0f0;
            display: inline-block;
        }
        .part-image-placeholder {
            width: 50px;
            height: 50px;
            display: inline-block;
            line-height: 50px;
            text-align: center;
            color: #999;
            font-size: 0.8rem;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.4);
            background-color: #eee;
            transition: transform 0.2s ease;
        }
        .color-swatch:hover { transform: scale(1.2); }
        .filter-option-content { display: flex; align-items: center; }
        .type-prefix {
            display: inline-block;
            min-width: 3.5em;
            margin-right: 4px;
            color: #777;
            font-family: monospace;
            font-size: 0.9em;
        }
        tfoot tr.total-row {
            font-weight: 600;
            background-color: #f1f1f1;
            border-top: 2px solid #ccc;
        }
        tfoot td { text-align: right; }
        tfoot td:first-child { text-align: left; }
        tfoot #total-quantity-cell { text-align: center; }
        @media (max-width: 768px) {
            .container { width: 98%; padding: 15px; overflow-x: auto; }
            .logo-and-input { flex-direction: column; align-items: stretch; }
            h1 { text-align: center; margin-bottom: 15px; }
            .file-input-area { flex-direction: column; align-items: stretch; }
            #file-info { text-align: center; margin-top: 5px; }
            #button-container { flex-direction: column; gap: 8px; }
            th, td { font-size: 0.85rem; padding: 8px 10px; }
            .part-image { max-width: 40px; max-height: 40px; }
            .part-image-placeholder { width: 40px; height: 40px; line-height: 40px; }
            .color-swatch { width: 15px; height: 15px; }
            .filter-column { width: 100%; box-sizing: border-box; }
        }
        @media (max-width: 480px) {
            th, td { font-size: 0.75rem; padding: 6px 8px; }
            .part-image, .part-image-placeholder { display: none; }
            td:nth-child(3), th:nth-child(3) { display: none; }
        }
        :root.dark-theme {
            --background-color: #1e1e1e;
            --text-color: #ddd;
            --primary-color: #1e90ff;
            --secondary-color: #28a745;
            --danger-color: #dc3545;
            --lego-red: #d81e2b;
        }
        body.dark-theme {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        body.dark-theme .container { background-color: #2c2c2c; }
        body.dark-theme table { background-color: #2c2c2c; }
        body.dark-theme th { background-color: #3c3c3c; color: #ddd; }
        body.dark-theme tbody tr:nth-child(even) { background-color: #333; }
        body.dark-theme tbody tr:hover { background-color: #444; }
        body.dark-theme .filter-column { background-color: #444; color: #ddd; }
        body.dark-theme .button { background-color: var(--primary-color); }
        body.dark-theme #load-file-button { background-color: var(--primary-color); }
        body.dark-theme #clear-button { background-color: var(--danger-color); }
        body.dark-theme #export-button { background-color: var(--secondary-color); }
        body.dark-theme #theme-toggle { background-color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка -->
        <div class="logo-and-input">
            <h1><img src="https://assets.lego.com/logos/v4.5.0/brand-lego.svg" alt="LEGO Logo"></h1>
            <div class="file-input-area" onclick="document.getElementById('htmlFileInput').click();">
                <span id="file-info">HTML файл корзины не выбран...</span>
                <input type="file" id="htmlFileInput" accept=".html, .htm" style="display: none;" aria-label="Выберите HTML файл корзины">
            </div>
        </div>

        <!-- Инструкция -->
        <details class="instructions" open>
            <summary>Как сохранить и загрузить файл корзины?</summary>
            <ol>
                <li>Откройте страницу с общей корзиной в вашем браузере (например, <code>https://shop-device.ru/sharebasket/...</code>).</li>
                <li>Нажмите <strong>Ctrl+S</strong> (или <strong>Cmd+S</strong> на Mac), или выберите в меню браузера "Файл" -> "Сохранить страницу как...".</li>
                <li>В окне сохранения выберите тип файла: <strong>"Веб-страница, только HTML"</strong> (или "HTML Only").</li>
                <li>Сохраните файл в удобное место на вашем компьютере.</li>
                <li>На этой странице нажмите кнопку "Загрузить HTML".</li>
                <li>Выберите сохраненный HTML-файл. Таблица будет создана автоматически.</li>
            </ol>
        </details>

        <!-- Кнопки управления -->
        <div id="button-container">
            <button id="load-file-button" class="button" aria-label="Загрузить HTML файл корзины">Загрузить HTML</button>
            <button id="clear-button" class="button" aria-label="Очистить таблицу и выбор файла">Очистить</button>
            <button id="export-button" class="button" disabled>Экспорт в CSV</button>
            <button id="theme-toggle" class="button">Темная тема</button>
        </div>

        <!-- Сообщения -->
        <div id="error-message"></div>
        <div id="info-message"></div>

        <!-- Поиск -->
        <input type="text" id="search-input" placeholder="Поиск по наименованию..." style="width: 100%; padding: 8px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc;">

        <!-- Общее количество -->
        <div id="total-parts-container">
            <img src="https://atlas-content-cdn.pixelsquid.com/stock-images/lego-2x2-brick-L6OYALC-600.jpg" alt="LEGO Brick"> Отображено деталей: <span id="total-parts">0</span>
        </div>

        <!-- Таблица -->
        <table id="lego-table" aria-label="Таблица деталей LEGO">
            <thead>
                <tr>
                    <th data-sort="number" data-sortable="true">№</th>
                    <th data-sort="name" data-sortable="false">Наименование</th>
                    <th data-sort="image" data-sortable="false">Фото</th>
                    <th data-sort="quantity" data-sortable="true">Кол-во</th>
                    <th data-sort="color" data-sortable="false">Цвет
                        <select class="filter-column" data-column="color" aria-label="Фильтр по цвету" title="Выберите цвет для фильтрации">
                            <option value="all" class="filter-option-all">-- Все --</option>
                        </select>
                    </th>
                    <th data-sort="condition" data-sortable="false">Состояние
                        <select class="filter-column" data-column="condition" aria-label="Фильтр по состоянию" title="Выберите состояние для фильтрации">
                            <option value="all" class="filter-option-all">-- Все --</option>
                        </select>
                    </th>
                    <th data-sort="type" data-sortable="false">Тип
                        <select class="filter-column" data-column="type" aria-label="Фильтр по типу" title="Выберите тип для фильтрации">
                            <option value="all" class="filter-option-all">-- Все --</option>
                        </select>
                    </th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="3">Итого:</td>
                    <td id="total-quantity-cell">0</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const htmlFileInput = document.getElementById('htmlFileInput');
            const loadFileButton = document.getElementById('load-file-button');
            const fileInfoSpan = document.getElementById('file-info');
            const clearButton = document.getElementById('clear-button');
            const exportButton = document.getElementById('export-button');
            const themeToggle = document.getElementById('theme-toggle');
            const searchInput = document.getElementById('search-input');
            const table = document.getElementById('lego-table');
            const tableBody = table.querySelector('tbody');
            const totalQuantityCell = document.getElementById('total-quantity-cell');
            const totalPartsSpan = document.getElementById('total-parts');
            const errorMessageDiv = document.getElementById('error-message');
            const infoMessageDiv = document.getElementById('info-message');
            const filterSelects = document.querySelectorAll('.filter-column');

            // --- State ---
            let rawPartsData = [];
            let currentFilters = { color: 'all', condition: 'all', type: 'all' };
            let currentSort = { field: 'number', direction: 'asc' };
            let searchQuery = '';

            // --- Color Definitions & Type Keywords ---
            const LEGO_COLORS_RU = ['бежевый', 'белый', 'голубой', 'жёлтый', 'желтый', 'зелёный', 'зеленый', 'коричневый', 'красный', 'оранжевый', 'розовый', 'салатовый', 'серый', 'синий', 'фиолетовый', 'чёрный', 'черный', 'прозрачный', 'золотой', 'серебряный', 'темно-серый', 'светло-серый', 'темно-синий', 'светло-голубой', 'темно-зеленый', 'ярко-зеленый', 'песочный', 'лаванда', 'пурпурный', 'лайм', 'аква', 'малиновый', 'бирюзовый'];
            const LEGO_COLORS_EN = ["dark bluish gray", "light bluish gray", "bright light blue", "bright light orange", "bright light yellow", "dark pearl gray", "pearl dark gray", "pearl light gray", "pearl sand blue", "speckle black-silver", "trans-bright green", "trans-dark blue", "trans-dark pink", "trans-light blue", "trans-medium blue", "trans-neon green", "trans-neon orange", "medium lavender", "medium nougat", "yellowish green", "chrome gold", "chrome silver", "dark azure", "dark green", "dark orange", "dark pink", "dark purple", "dark red", "dark tan", "dark turquoise", "flat silver", "light gray", "medium azure", "medium blue", "metallic silver", "olive green", "pearl gold", "sand blue", "sand green", "trans-black", "trans-clear", "trans-green", "trans-orange", "trans-purple", "trans-red", "trans-yellow", "bright green", "bright pink", "dark blue", "dark gray", "light blue", "magenta", "orange", "purple", "silver", "yellow", "black", "blue", "brown", "green", "lime", "pink", "red", "tan", "white", "gold", "copper"].sort((a, b) => b.length - a.length);
            const COLOR_MAP = {
                'белый': '#FFFFFF', 'черный': '#05131D', 'чёрный': '#05131D', 'серый': '#9BA19D', 'темно-серый': '#6D6E5C', 'светло-серый': '#A0A5A9', 'синий': '#0055BF', 'темно-синий': '#0A3463', 'голубой': '#55A5AF', 'светло-голубой': '#B4D2E3', 'зелёный': '#237841', 'зеленый': '#237841', 'лайм': '#9BCA3E', 'салатовый': '#9BCA3E', 'темно-зеленый': '#184632', 'жёлтый': '#F2CD37', 'желтый': '#F2CD37', 'оранжевый': '#FE8A18', 'красный': '#C91A09', 'коричневый': '#583927', 'бежевый': '#E4CD9E', 'песочный': '#E4CD9E', 'розовый': '#FC97AC', 'фиолетовый': '#81007B', 'пурпурный': '#4B0082', 'лаванда': '#AC78BA', 'прозрачный': 'rgba(220,220,230,0.5)', 'золотой': '#BBA53D', 'серебряный': '#898788', 'white': '#FFFFFF', 'black': '#05131D', 'light gray': '#9BA19D', 'dark gray': '#6D6E5C', 'light bluish gray': '#A0A5A9', 'dark bluish gray': '#6C6E68', 'blue': '#0055BF', 'dark blue': '#0A3463', 'medium blue': '#5C9DD1', 'light blue': '#B4D2E3', 'bright light blue': '#B4D2E3', 'green': '#237841', 'dark green': '#184632', 'bright green': '#4B9F4A', 'lime': '#9BCA3E', 'yellow': '#F2CD37', 'bright light yellow': '#FFF03A', 'orange': '#FE8A18', 'bright light orange': '#F8BB3D', 'red': '#C91A09', 'dark red': '#720E0F', 'brown': '#583927', 'dark brown': '#352100', 'tan': '#E4CD9E', 'dark tan': '#958A73', 'pink': '#FC97AC', 'bright pink': '#E4ADC8', 'purple': '#81007B', 'dark purple': '#3F3691', 'magenta': '#923978', 'lavender': '#AC78BA', 'medium lavender': '#AC78BA', 'trans-clear': 'rgba(240,240,240,0.7)', 'trans-black': 'rgba(99, 95, 97, 0.7)', 'trans-red': 'rgba(200, 40, 40, 0.7)', 'trans-dark-blue': 'rgba(0, 80, 150, 0.7)', 'trans-light-blue': 'rgba(170, 200, 220, 0.7)', 'gold': '#BBA53D', 'pearl gold': '#AA9535', 'silver': '#898788', 'flat silver': '#898788', 'metallic silver': '#A0A1A4', 'pearl light gray': '#A0A5A9', 'dark pearl gray': '#575857', 'chrome gold': '#E0B02E', 'chrome silver': '#C0C0C0', 'n/a': '#CCCCCC'
            };
            const TYPE_KEYWORDS = {
                'plate modified': 'Пластины (мод.)', 'plate': 'Пластины', 'brick modified': 'Кирпичи (мод.)', 'brick arch': 'Кирпичи (арки)', 'brick round': 'Кирпичи (круглые)', 'brick': 'Кирпичи', 'tile modified': 'Плитки (мод.)', 'tile round': 'Плитки (круглые)', 'tile': 'Плитки', 'slope inverted': 'Скосы (инверт.)', 'slope curved': 'Скосы (изогнутые)', 'slope': 'Скосы', 'wedge plate': 'Клинья (пластины)', 'wedge': 'Клинья', 'panel': 'Панели', 'window': 'Окна/Двери', 'door': 'Окна/Двери', 'glass': 'Окна/Двери (стекло)', 'technic brick': 'Technic Кирпичи', 'technic pin': 'Technic Пины/Оси', 'technic axle': 'Technic Пины/Оси', 'technic connector': 'Technic Коннекторы', 'technic gear': 'Technic Шестерни', 'technic beam': 'Technic Балки', 'technic liftarm': 'Technic Балки', 'technic': 'Technic', 'bar': 'Стержни/Решетки', 'fence': 'Стержни/Решетки', 'ladder': 'Стержни/Решетки', 'clip': 'Клипсы/Зажимы', 'hinge': 'Шарниры/Петли', 'cone': 'Конусы/Цилиндры', 'cylinder': 'Конусы/Цилиндры', 'minifigure': 'Минифигурки/Аксессуары', 'minifig': 'Минифигурки/Аксессуары', 'weapon': 'Минифигурки/Аксессуары', 'utensil': 'Минифигурки/Аксессуары', 'head': 'Минифигурки/Аксессуары', 'hair': 'Минифигурки/Аксессуары', 'torso': 'Минифигурки/Аксессуары', 'legs': 'Минифигурки/Аксессуары', 'helmet': 'Минифигурки/Аксессуары', 'wheel': 'Колеса/Шины', 'tire': 'Колеса/Шины', 'container': 'Контейнеры', 'box': 'Контейнеры', 'animal': 'Животные/Растения', 'plant': 'Животные/Растения', 'flower': 'Животные/Растения', 'пластина': 'Пластины', 'кирпич': 'Кирпичи', 'кубик': 'Кирпичи', 'плитка': 'Плитки', 'скос': 'Скосы', 'панель': 'Панели', 'решетка': 'Стержни/Решетки', 'зажим': 'Клипсы/Зажимы', 'ось': 'Technic Пины/Оси', 'балка': 'Technic Балки', 'шестерня': 'Technic Шестерни', 'колесо': 'Колеса/Шины', 'шина': 'Колеса/Шины', 'растение': 'Животные/Растения', 'цветок': 'Животные/Растения'
            };
            const SORTED_TYPE_KEYS = Object.keys(TYPE_KEYWORDS).sort((a, b) => b.length - a.length);
            const TYPE_PREFIX_MAP = {
                'Пластины': '[PLT]', 'Пластины (мод.)': '[PLT+]', 'Кирпичи': '[BRK]', 'Кирпичи (мод.)': '[BRK+]', 'Кирпичи (арки)': '[ARC]', 'Кирпичи (круглые)': '[RND]', 'Плитки': '[TLE]', 'Плитки (мод.)': '[TLE+]', 'Плитки (круглые)': '[RND]', 'Скосы': '[SLP]', 'Скосы (инверт.)': '[SLP-]', 'Скосы (изогнутые)': '[SLP~]', 'Клинья': '[WDG]', 'Клинья (пластины)': '[WDG~]', 'Панели': '[PNL]', 'Окна/Двери': '[WIN]', 'Окна/Двери (стекло)': '[GLS]', 'Technic': '[TCH]', 'Technic Кирпичи': '[TCH B]', 'Technic Пины/Оси': '[TCH P]', 'Technic Коннекторы': '[TCH C]', 'Technic Шестерни': '[TCH G]', 'Technic Балки': '[TCH L]', 'Стержни/Решетки': '[BAR]', 'Клипсы/Зажимы': '[CLP]', 'Шарниры/Петли': '[HNG]', 'Конусы/Цилиндры': '[CON]', 'Минифигурки/Аксессуары': '[FIG]', 'Колеса/Шины': '[WHL]', 'Контейнеры': '[BOX]', 'Животные/Растения': '[BIO]', 'Другое': '[OTH]', 'N/A': '[N/A]'
            };

            // --- Functions ---
            const showMessage = (msg, type = 'error') => {
                const div = type === 'error' ? errorMessageDiv : infoMessageDiv;
                const otherDiv = type === 'error' ? infoMessageDiv : errorMessageDiv;
                div.textContent = msg;
                div.style.display = 'block';
                otherDiv.style.display = 'none';
                setTimeout(() => { div.style.display = 'none'; }, 5000);
            };
            const clearMessages = () => {
                errorMessageDiv.style.display = 'none';
                infoMessageDiv.style.display = 'none';
            };
            function getCssColor(colorName) {
                return COLOR_MAP[colorName.toLowerCase()] || '#CCCCCC';
            }
            const debounce = (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            };
            const getColumnIndex = (column) => {
                const headers = table.querySelectorAll('thead th');
                for (let i = 0; i < headers.length; i++) {
                    if (headers[i].dataset.sort === column) return i;
                }
                return -1;
            };
            function extractColorFromName(name) {
                const lowerName = name.toLowerCase();
                let foundColor = null;
                let sourceText = '';
                const matchInParentheses = lowerName.match(/\(([^)]+)\)/);
                if (matchInParentheses && matchInParentheses[1]) {
                    sourceText = matchInParentheses[1].trim();
                    foundColor = LEGO_COLORS_RU.find(color => sourceText.includes(color));
                    if (foundColor) return foundColor.charAt(0).toUpperCase() + foundColor.slice(1);
                }
                const lastParenthesisIndex = lowerName.lastIndexOf(')');
                if (lastParenthesisIndex !== -1) {
                    sourceText = name.substring(lastParenthesisIndex + 1).trim().replace(/(\s+[a-zA-Z0-9])$/, '').trim();
                    const lowerSourceText = sourceText.toLowerCase();
                    if (lowerSourceText) {
                        foundColor = LEGO_COLORS_EN.find(color => lowerSourceText.includes(color.toLowerCase()));
                        if (foundColor) {
                            const regex = new RegExp(`\\b${foundColor.replace(/[-\s]/g, '[-\\s]')}\\b`, 'i');
                            if (regex.test(sourceText)) return foundColor.charAt(0).toUpperCase() + foundColor.slice(1);
                        }
                    }
                }
                sourceText = name.trim().replace(/(\s+[a-zA-Z0-9])$/, '').trim();
                const lowerSourceText = sourceText.toLowerCase();
                foundColor = LEGO_COLORS_EN.find(color => lowerSourceText.endsWith(color.toLowerCase()));
                if (foundColor) return foundColor.charAt(0).toUpperCase() + foundColor.slice(1);
                return 'N/A';
            }
            function extractConditionFromName(name) {
                if (/\sU$/.test(name)) return 'Б/У';
                if (/\sN$/.test(name)) return 'Новая';
                return 'Неизвестно';
            }
            function extractPartType(name) {
                let cleanName = name.replace(/\(([^)]+)\)/g, '');
                cleanName = cleanName.replace(/\s(U|N)$/, '');
                const detectedColor = extractColorFromName(name);
                if (detectedColor !== 'N/A') {
                    const colorEn = Object.keys(COLOR_MAP).find(key => COLOR_MAP[key] === getCssColor(detectedColor) && /^[a-z\s-]+$/.test(key));
                    const colorRu = Object.keys(COLOR_MAP).find(key => COLOR_MAP[key] === getCssColor(detectedColor) && /^[а-яё\s-]+$/.test(key));
                    if (colorEn) cleanName = cleanName.replace(new RegExp(`\\b${colorEn}\\b`, 'gi'), '');
                    if (colorRu) cleanName = cleanName.replace(new RegExp(`\\b${colorRu}\\b`, 'gi'), '');
                    cleanName = cleanName.replace(new RegExp(`\\b${detectedColor}\\b`, 'gi'), '');
                }
                cleanName = cleanName.toLowerCase().trim();
                for (const keyword of SORTED_TYPE_KEYS) {
                    if (cleanName.includes(keyword)) {
                        return TYPE_KEYWORDS[keyword];
                    }
                }
                return 'Другое';
            }
            function parseBasketHtml(htmlString) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');
                const itemsContainer = doc.querySelector('.basket-share-detail__items');
                if (!itemsContainer) throw new Error("Не найден контейнер деталей ('.basket-share-detail__items'). Проверьте структуру HTML.");
                const items = itemsContainer.querySelectorAll('.basket-share-detail__item');
                if (items.length === 0) {
                    showMessage("В файле не найдено элементов корзины ('.basket-share-detail__item').", 'warning');
                    return [];
                }
                const partsData = [];
                let baseUrl = 'https://shop-device.ru';
                const baseTag = doc.querySelector('base[href]');
                if (baseTag?.href?.startsWith('http')) baseUrl = baseTag.href.replace(/\/$/, '');
                items.forEach((item, index) => {
                    const nameElement = item.querySelector('.basket-share-detail__item__name a.dark_link');
                    const quantityElement = item.querySelector('.basket-share-detail__item__quantity');
                    const imageElement = item.querySelector('.basket-share-detail__item__image img');
                    let name = nameElement?.textContent.trim() ?? `Название не найдено #${index + 1}`;
                    let quantity = parseInt(quantityElement?.textContent.match(/(\d+)/)?.[1] ?? '0', 10);
                    let imageUrl = null;
                    if (imageElement) {
                        let potentialSrc = imageElement.getAttribute('data-src') || imageElement.getAttribute('src');
                        if (potentialSrc?.startsWith('/')) imageUrl = baseUrl + potentialSrc;
                        else if (potentialSrc?.startsWith('http')) imageUrl = potentialSrc;
                    }
                    const color = extractColorFromName(name);
                    const condition = extractConditionFromName(name);
                    const type = extractPartType(name);
                    if (quantity > 0) {
                        partsData.push({ name, quantity, imageUrl, color, condition, type });
                    }
                });
                return partsData;
            }
            const clearTable = () => {
                rawPartsData = [];
                tableBody.innerHTML = '';
                totalQuantityCell.textContent = '0';
                totalPartsSpan.textContent = '0';
                filterSelects.forEach(select => {
                    while (select.options.length > 1) select.remove(1);
                    select.value = 'all';
                });
                currentFilters = { color: 'all', condition: 'all', type: 'all' };
                currentSort = { field: 'number', direction: 'asc' };
                searchQuery = '';
                searchInput.value = '';
                table.querySelectorAll('thead th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
                table.querySelector('#lego-table th[data-sort="number"]')?.classList.add('sort-asc');
                fileInfoSpan.textContent = 'HTML файл корзины не выбран...';
                htmlFileInput.value = '';
                clearMessages();
                disableControls(true);
                exportButton.disabled = true;
            };
            const populateFilter = (column) => {
                const filterSelect = table.querySelector(`th[data-sort="${column}"] select.filter-column`);
                if (!filterSelect) return;
                while (filterSelect.options.length > 1) filterSelect.remove(1);
                const uniqueValues = [...new Set(rawPartsData.map(part => part[column]))]
                    .filter(value => value != null)
                    .sort((a, b) => String(a).localeCompare(String(b), 'ru', { sensitivity: 'base' }));
                uniqueValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.className = 'filter-option';
                    if (column === 'color' && value !== 'N/A') {
                        const colorCode = getCssColor(value);
                        option.innerHTML = `<span class="filter-option-content"><span class="color-swatch" style="background-color: ${colorCode};"></span><span>${value}</span></span>`;
                    } else if (column === 'type') {
                        const prefix = TYPE_PREFIX_MAP[value] || '[???]';
                        option.textContent = `${prefix} ${value}`;
                    } else {
                        option.textContent = value;
                    }
                    filterSelect.appendChild(option);
                });
                filterSelect.value = currentFilters[column];
            };
            const applyFiltersAndSort = () => {
                let filteredData = [...rawPartsData];
                if (searchQuery) {
                    filteredData = filteredData.filter(part => part.name.toLowerCase().includes(searchQuery));
                }
                Object.keys(currentFilters).forEach(column => {
                    const filterValue = currentFilters[column];
                    if (filterValue !== 'all') {
                        filteredData = filteredData.filter(part => String(part[column]) === filterValue);
                    }
                });
                const { field, direction } = currentSort;
                if (field) {
                    filteredData.sort((a, b) => {
                        let valA = a[field];
                        let valB = b[field];
                        let comparison = 0;
                        if (field === 'number' || field === 'quantity') {
                            comparison = (Number(valA) || 0) - (Number(valB) || 0);
                        } else {
                            if (valA === 'N/A' && valB !== 'N/A') return 1;
                            if (valA !== 'N/A' && valB === 'N/A') return -1;
                            if (valA === 'Неизвестно' && valB !== 'Неизвестно') return 1;
                            if (valA !== 'Неизвестно' && valB === 'Неизвестно') return -1;
                            comparison = String(valA).localeCompare(String(valB), 'ru', { sensitivity: 'base' });
                        }
                        return direction === 'asc' ? comparison : (comparison * -1);
                    });
                }
                renderTable(filteredData);
                updateTotals(filteredData);
                updateSortIndicators();
            };
            const renderTable = (data) => {
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #777;">Нет данных для отображения</td></tr>';
                    return;
                }
                let rowCount = 1;
                data.forEach(detail => {
                    const row = tableBody.insertRow();
                    row.setAttribute('aria-label', `Строка ${rowCount}: ${detail.name}`);
                    row.insertCell().textContent = rowCount++;
                    const cellName = row.insertCell();
                    cellName.textContent = detail.name;
                    cellName.title = detail.name;
                    const imgCell = row.insertCell();
                    if (detail.imageUrl) {
                        const img = document.createElement('img');
                        img.src = detail.imageUrl;
                        img.alt = detail.name.substring(0, 30);
                        img.classList.add('part-image');
                        img.setAttribute('loading', 'lazy');
                        img.onerror = () => {
                            imgCell.innerHTML = '<span class="part-image-placeholder">Фото<br>нет</span>';
                        };
                        imgCell.appendChild(img);
                    } else {
                        imgCell.innerHTML = '<span class="part-image-placeholder">Фото<br>нет</span>';
                    }
                    const qtyCell = row.insertCell();
                    const qtyInput = document.createElement('input');
                    qtyInput.type = 'number';
                    qtyInput.value = detail.quantity;
                    qtyInput.min = 0;
                    qtyInput.style.width = '60px';
                    qtyInput.addEventListener('change', (e) => {
                        const newQty = parseInt(e.target.value, 10);
                        if (!isNaN(newQty) && newQty >= 0) {
                            detail.quantity = newQty;
                            applyFiltersAndSort();
                        }
                    });
                    qtyCell.appendChild(qtyInput);
                    const colorCell = row.insertCell();
                    const swatch = document.createElement('span');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = getCssColor(detail.color);
                    swatch.title = detail.color;
                    colorCell.appendChild(swatch);
                    colorCell.appendChild(document.createTextNode(` ${detail.color}`));
                    row.insertCell().textContent = detail.condition;
                    row.insertCell().textContent = detail.type;
                });
            };
            const updateTotals = (data) => {
                const total = data.reduce((sum, part) => sum + part.quantity, 0);
                totalQuantityCell.textContent = total;
                totalPartsSpan.textContent = total;
            };
            const updateSortIndicators = () => {
                table.querySelectorAll('thead th').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    if (th.dataset.sort === currentSort.field) {
                        th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            };
            const handleSortClick = (event) => {
                const header = event.target.closest('th[data-sortable="true"]');
                if (!header) return;
                const field = header.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                applyFiltersAndSort();
            };
            const disableControls = (disabled) => {
                clearButton.disabled = disabled;
                exportButton.disabled = disabled || rawPartsData.length === 0;
                filterSelects.forEach(sel => sel.disabled = disabled);
                table.querySelectorAll('thead th[data-sortable="true"]').forEach(th => {
                    th.style.cursor = disabled ? 'default' : 'pointer';
                });
            };
            function exportToCSV(data) {
                const csv = ['№,Наименование,Фото,Кол-во,Цвет,Состояние,Тип']
                    .concat(data.map((part, i) => `${i + 1},${part.name},${part.imageUrl || ''},${part.quantity},${part.color},${part.condition},${part.type}`))
                    .join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'lego_parts.csv';
                link.click();
            }

            // --- Event Listeners ---
            loadFileButton.addEventListener('click', () => {
                htmlFileInput.click();
            });
            htmlFileInput.addEventListener('change', (event) => {
                clearMessages();
                const file = event.target.files[0];
                if (!file) {
                    fileInfoSpan.textContent = 'Файл не выбран.';
                    return;
                }
                if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
                    showMessage('Пожалуйста, выберите файл с расширением .html или .htm', 'error');
                    htmlFileInput.value = '';
                    return;
                }
                fileInfoSpan.textContent = `Загрузка: ${file.name}...`;
                fileInfoSpan.classList.add('loading');
                disableControls(true);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        if (!e.target || typeof e.target.result !== 'string') {
                            throw new Error("Не удалось прочитать содержимое файла.");
                        }
                        rawPartsData = parseBasketHtml(e.target.result);
                        if (rawPartsData.length > 0) {
                            fileInfoSpan.textContent = `Загружен: ${file.name} (${rawPartsData.length} поз.)`;
                            populateFilter('color');
                            populateFilter('condition');
                            populateFilter('type');
                            currentSort = { field: 'number', direction: 'asc' };
                            applyFiltersAndSort();
                            disableControls(false);
                            exportButton.disabled = false;
                           s = false;
                            showMessage(`Файл успешно обработан. Найдено позиций: ${rawPartsData.length}`, 'info');
                        } else {
                            fileInfoSpan.textContent = `Файл ${file.name} обработан, но не содержит распознанных деталей.`;
                            clearTable();
                        }
                    } catch (error) {
                        showMessage(`Ошибка обработки файла: ${error.message}`, 'error');
                        clearTable();
                        fileInfoSpan.textContent = `Ошибка при чтении ${file.name}`;
                    } finally {
                        fileInfoSpan.classList.remove('loading');
                        htmlFileInput.value = '';
                    }
                };
                reader.onerror = () => {
                    showMessage(`Не удалось прочитать файл ${file.name}. Ошибка: ${reader.error?.name ?? 'Неизвестная ошибка'}`, 'error');
                    clearTable();
                    fileInfoSpan.textContent = `Ошибка чтения файла`;
                    fileInfoSpan.classList.remove('loading');
                    htmlFileInput.value = '';
                };
                reader.readAsText(file);
            });
            filterSelects.forEach(select => {
                select.addEventListener('change', debounce((event) => {
                    currentFilters[event.target.dataset.column] = event.target.value;
                    applyFiltersAndSort();
                }, 250));
            });
            table.querySelector('thead').addEventListener('click', handleSortClick);
            clearButton.addEventListener('click', clearTable);
            searchInput.addEventListener('input', debounce((e) => {
                searchQuery = e.target.value.toLowerCase();
                applyFiltersAndSort();
            }, 300));
            exportButton.addEventListener('click', () => exportToCSV(rawPartsData));
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-theme');
                themeToggle.textContent = document.body.classList.contains('dark-theme') ? 'Светлая тема' : 'Темная тема';
            });

            // --- Initial State ---
            clearTable();
            disableControls(true);
        });
    </script>
</body>
</html>
